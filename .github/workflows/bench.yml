name: benchmarks
on:
  workflow_call:
    inputs:
      chapel_version:
        description: 'Chapel version to use (latest, nightly, or a specific version)'
        required: true
        type: string

jobs:

  # this just runs the benchmarks to make sure they compile and run
  test-benchmarks:
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
        backend: [llvm]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Chapel
        uses: jabraham17/setup-chpl@v1
        with:
          version: ${{ inputs.chapel_version }}
          backend: ${{ matrix.backend }}
      - name: Install Python Dependencies
        run: |
          python3 -m venv .venv
          ./.venv/bin/python3 -m pip install --upgrade pip
          ./.venv/bin/python3 -m pip install pydantic
      - name: Setup fortran
        # fortran-lang/setup-fortran has some bugs when running in a container
        # and bad usage of sudo, so use jabraham17/setup-fortran@fix-cd until
        # those are fixed
        uses: jabraham17/setup-fortran@fix-cd
        with:
          compiler: gcc
          version: latest
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
      - name: Build CVL Dependencies
        run: |
          ./third-party/sleef/install.sh
      - name: Run Benchmarks
        run: |
          ./.venv/bin/python3 ./util/bench.py \
            --schema benchmarks/benchmarks.json \
            --trials 3 --small \
            --cvl-options "$(./compile.py --sleef)"
